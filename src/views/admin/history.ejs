<!doctype html><html lang="es"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title><%= title %></title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="/css/styles.css" rel="stylesheet">
</head><body>
<div class="container my-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3>Historial de visitas</h3>
    <a href="/admin" class="btn btn-outline-secondary">Volver al panel</a>
  </div>

  <div class="alert alert-info">
    Los registros se agregan automáticamente al confirmar una reserva como <strong>pagada</strong>.
    También puedes agregar manualmente un registro.
  </div>

  <form class="row g-2 mb-4" method="post" action="/admin/historial/add">
    <div class="col-md-3"><label class="form-label">Fecha/Hora</label><input name="record_at" type="datetime-local" class="form-control"></div>
    <div class="col-md-4"><label class="form-label">Actividad</label><input name="activity_name" class="form-control" placeholder="Nombre de la actividad"></div>
    <div class="col-md-2"><label class="form-label">Personas (JSON)</label><input name="people_json" class="form-control" placeholder='[{"name":"Ana","age_band":"19-26"}]'></div>
    <div class="col-md-3"><label class="form-label">Teléfono</label><input name="phone" class="form-control"></div>
    <div class="col-md-3"><label class="form-label">Correo</label><input name="email" class="form-control"></div>
    <div class="col-md-2"><label class="form-label">Pago</label><input name="pay_method" class="form-control" placeholder="deposito/paypal/mp"></div>
    <div class="col-md-2"><label class="form-label">Monto (centavos)</label><input name="amount_cents" type="number" class="form-control" value="0"></div>
    <div class="col-md-12"><label class="form-label">Notas</label><input name="notes" class="form-control"></div>
    <div class="col-md-2"><label class="form-label">&nbsp;</label><button class="btn btn-success w-100">Agregar</button></div>
  </form>

  <table class="table table-sm">
    <thead><tr><th>Fecha</th><th>Actividad</th><th>Personas</th><th>Tel</th><th>Pago</th><th>Monto</th><th></th></tr></thead>
    <tbody>
      <% list.forEach(function(r){ %>
        <tr>
          <td><%= dayjs(r.record_at).format('DD/MM/YYYY HH:mm') %></td>
          <td><%= r.activity_name || r.activity_id || '' %></td>
          <td>
            <% try { const ps = JSON.parse(r.people_json||'[]'); %>
              <%= ps.map(p=>p.name + (p.age_band? ' ('+p.age_band+')':'' )).join(', ') %>
            <% } catch(e){ %><%= r.people_json %><% } %>
          </td>
          <td><%= r.phone || '' %></td>
          <td><%= r.pay_method || '' %></td>
          <td>$ <%= ((r.amount_cents||0)/100).toFixed(2) %></td>
          <td>
            <form method="post" action="/admin/historial/<%= r.id %>/delete" onsubmit="return confirm('¿Eliminar registro?')">
              <button class="btn btn-sm btn-outline-danger">Eliminar</button>
            </form>
          </td>
        </tr>
      <% }) %>
    </tbody>
  </table>
  <%- include('pagination', { pagination: pagination }) %>
</div>
</body></html>
